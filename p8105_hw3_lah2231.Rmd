---
title: "p8105_hw3_lah2231"
output: github_document
date: "2024-10-13"
---
```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
```

# Problem 1

```{r}
devtools::install_github("P8105/p8105.datasets")
library(p8105.datasets)
```

```{r}
ny_weather <- ny_noaa
head(ny_weather)
#View(ny_weather)
```
```{r}
str(ny_weather)
colnames(ny_weather)
nrow(ny_weather)
ncol(ny_weather)
```
```{r}
colSums(is.na(ny_weather))
```

The NOAA dataset contains information about weather data such as temperature and snowfall. The columns are called `r colnames(ny_weather)`. The dataset contains `r nrow(ny_weather)` rows and `r ncol(ny_weather)` columns. The variables recorded are for example precipitation, snowfall, snow depth, maximum temperature and minimum temperature. In addition to that there are station identification numbers and dates of observations.

There are `r sum(is.na(ny_weather))` missing values in the dataset overall. Precipitation has `r sum(is.na(ny_weather[,"prcp"]))` missing values, snowfall has `r sum(is.na(ny_weather[,"snow"]))` missing, snow depth has `r sum(is.na(ny_weather[,"snwd"]))` missing, maximum temperature has `r sum(is.na(ny_weather[,"tmax"]))` missing, and minimum temperature has `r sum(is.na(ny_weather[,"tmin"]))` missing.

## Data cleaning
```{r}
ny_weather_clean <- ny_noaa %>%
  mutate(
    year = year(date),
    month = month(date, label = TRUE),
    day = day(date),
    tmax = as.numeric(tmax) / 10,
    tmin = as.numeric(tmin) / 10,
    prcp = prcp / 10
  )
head(ny_weather_clean)
```
I cleaned the data by turning the date into separate variables for year, month and day and I changed the temperature from tenths of degrees celsius to degrees celsius and precipitation from teths of milimeters to mm.

## Common snowfall values
```{r}
snowfall_common <- ny_weather_clean %>%
  filter(!is.na(snow)) %>% 
  group_by(snow) %>%
  summarize(count = n()) %>%
  arrange(desc(count))

head(snowfall_common)

```
The most common snowfall value is zero, which is probably the case because it does not snow in New York on most days.

## Plotting 
```{r}
avg_tmax_simple <- ny_weather_clean %>%
  filter((month == "Jan") | (month == "Jul")) %>%
  filter(!is.na(tmax)) %>%
  group_by(year, month) %>%
  summarize(avg_tmax = mean(tmax)) %>%
  ungroup()

ggplot(avg_tmax_simple, aes(x = year, y = avg_tmax)) +
  geom_line() +
  facet_wrap(~month, ncol = 1) +
  labs(
    title = "Aerage max temperature",
    x = "year",
    y = "average max temperature"
  )
```
I have made a two panel plot by taking the average mx temp in january and july after removing missing tmax values. One can see that it correlates that in some years if january was rather warm july was also rather warm.

## Temperature comparison plot
```{r}
ggplot(ny_weather_clean, aes(x = tmin, y = tmax)) +
  geom_density_2d() +
  labs(
    title = "tmax and tmin",
    x = "min temp",
    y = "max temp"
  )
```

This plot shows the relationship between tmax and tmin using a 2D bin plot using geom_bin2d because of the large amount of data.


# Problem 2

```{r}
demographic_data <- read_csv("data/demographic_data.csv", skip = 4)

accelerometer_data <- read_csv("data/accelerometer_data.csv")

head(demographic_data)
head(accelerometer_data)
```
I put the data from the website into csv files and loaded them. I immediately took out the extra lines with other information from the demographic data.

## Organizig Data
```{r}
demographic_clean <- demographic_data %>%
  filter(age >= 21) %>%
  drop_na(sex, age, BMI, education)
```
I have now removed participants under 21 years of age and missing demographic data

```{r}
merged_data <- demographic_clean %>%
  inner_join(accelerometer_data, by = "SEQN")
```
And now I have merged on the seqn column

```{r}
# Convert sex and education to factors
merged_data <- merged_data %>%
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    education = factor(education, levels = c(1, 2, 3), 
                       labels = c("Less than high school", "High school equivalent", "More than high school"))
  )
```

As instructed I converted sex and education to the given factors as instructed

```{r}
head(merged_data)
```
## Education by Gender Analysis
```{r}
gender_education_table <- merged_data %>%
  group_by(education, sex) %>%
  summarize(count = n()) %>%
  pivot_wider(names_from = sex, values_from = count)

print(gender_education_table)
```

I made a better looking table showing the number of men and women in each education category. Most people had more than a high school education. A few more women had more than high school in comparison to men and a few more men had a high school equivalent in comparison to women. 

## Plotting age distribution by education category seperated by sex
```{r}
ggplot(merged_data, aes(x = age, fill = sex)) +
  geom_density(alpha = 0.4) + 
  facet_wrap(~education) +
  labs(
    title = "Age by gender and education category",
    x = "Age",
    y = "Density",
    fill = "Gender"
  )
```

I plotted the age distribution for men and women in each education category. There seems to be a peak of 20-40 year old women with more than high school education. I am not knowledgeable enough whatsoever in this area to really comment on it but I guess it is consistent with things I have read and not great, maybe there are issues in the way school is structured causing more difficulties for men.

## Plotting Total activity 
```{r}
merged_data <- merged_data %>%
  rowwise() %>%
  mutate(total_activity = sum(c_across(starts_with("min")), na.rm = TRUE)) %>%
  ungroup()

ggplot(merged_data, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.6) +
  geom_smooth() +
  facet_wrap(~education) +
  labs(
    title = "Total activity vs age, by gender and education level",
    x = "Age",
    y = "Total activity",
    color = "Gender"
  )
```

I created a total variable of activity for each person using rowwise addition and starts_with to collect data from all columns. Afterwards I ungrouped. I then made the plot showing total activity vs age, comparing men to women, with separate panels for education levels.
We find that there is the most activity in the less than high school education group at the age of around 21 - 30. Then there is a stronger decline than in all other groups in the less than high school group. I am not an expert in this field but my interpretation would be that people that did not finish high school might work in more physically demanding jobs early on and they might be more prone to injury due to these jobs which could be leading to less activity at an older age. Contrarily, people with more than high school education had a more consistent activity pattern throughout their life, with surprisingly women being more active

## Plotting daytime activity
```{r}
accelerometer_long <- merged_data %>%
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               values_to = "activity") %>%
  mutate(minute = as.numeric(str_replace(minute, "min", "")))

ggplot(accelerometer_long, aes(x = minute, y = activity, color = sex)) +
  geom_line(alpha = 0.25) +
  geom_smooth() +
  facet_wrap(~education) +
  scale_color_manual(values = c("Male" = "green", "Female" = "orange")) +
  labs(
    title = "Activity over time by education level and sex",
    x = "Minute",
    y = "Activity level",
    color = "Sex"
  )
```

I put the data into long format, converted the minute labels to numbers and made the plot that shows activity over time for each education level, with green lines for men and orange lines for women. There is more data the more than high school group and that most probably explains the more intense coloring. Generally people seem to  be more active during the day, which is more consistent in third group, possibly because it is more sedentary work. For the first two groups the lines fall a little bit indicating more physically demanding jobs in the morning. There are peaks in the morning and evening in the more than high school group which might be indicating that that group of people works out during those times. Such peaks do not exist so strongly in the other groups.


# Problem 3

## Importing data and putting into one dataset
```{r}
jan_2020 <- read_csv("data/Jan 2020 Citi.csv")
jan_2024 <- read_csv("data/Jan 2024 Citi.csv")
july_2020 <- read_csv("data/July 2020 Citi.csv")
july_2024 <- read_csv("data/July 2024 Citi.csv")

#head(jan_2020)

jan_2020 <- jan_2020 %>%
  mutate(month = "January", year = 2020)

jan_2024 <- jan_2024 %>%
  mutate(month = "January", year = 2024)

july_2020 <- july_2020 %>%
  mutate(month = "July", year = 2020)

july_2024 <- july_2024 %>%
  mutate(month = "July", year = 2024)

combined_data <- bind_rows(jan_2020, jan_2024, july_2020, july_2024)

# Display the first few rows of the combined data
head(combined_data)
```

```{r}
colSums(is.na(combined_data))
```
## Cleaning
```{r}
cleaned_data <- combined_data %>% drop_na()
```

```{r}
summary(cleaned_data)
```
I imported the four citi bike datasets. The dataset for January 2020 had `r ncol(jan_2020)` columns and `r nrow(jan_2020)` rows. The dataset for July 2020 had `r ncol(july_2020)` columns and `r nrow(july_2020)` rows. The dataset for January 2024 had `r ncol(jan_2024)` columns and `r nrow(jan_2024)` rows. The dataset for July 2024 had `r ncol(july_2024)` columns and `r nrow(july_2024)` rows.I combined all the datasets into onde after adding a column to identify month and year using bind_rows(). I checked for missing values and there were: 43 missing values in start_station_name and 207 missing values in end_station_name. I removed lines with missing values. The cleaned dataset had 99,253 rows and included ride duration values from 1 up to 238.780 minutes.

## Summary table rides by year + month and seperating by rider type
```{r}
ride_summary <- cleaned_data %>%
  group_by(year, month) %>%
  summarise(
    member_rides = sum(member_casual == "member"),
    casual_rides = sum(member_casual == "casual")
  )

print(ride_summary)

```

I used group by to seperate by year, month and then summarise accorfing to member_casual column

```{r}
knitr::kable(ride_summary)
```
In the table we can see that the number of members riding bikes rose dramatically especially in the summer when comparing 2020 and 2024 (from 15388 to 36200). Generally there are more riders in the July than in january which was to be expected due to weather conditions.

```{r}
july_2024_data <- cleaned_data %>%
  filter(month == "July", year == 2024)

top_stations <- july_2024_data %>%
  group_by(start_station_name) %>%
  summarise(total_rides = n()) %>%
  arrange(desc(total_rides)) %>%
  slice_head(n = 5)

print(top_stations)
knitr::kable(top_stations)
```

I filtered out all the July 24 data. Then I grouped by start stations, found the total rides, arranged them and took the top 5. The top stations were: `r top_stations$start_station_name[1:5]`.

## Comparison median ride duration looking at days, months and the two years
```{r}
median_duration_data <- cleaned_data %>%
  mutate(weekdays = factor(weekdays, 
                           levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"),
                           labels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"))) %>%
  group_by(weekdays, month, year) %>%
  summarise(median_duration = median(duration)) %>%
  ungroup()

ggplot(median_duration_data, aes(x = weekdays, y = median_duration, group = weekdays)) +
  geom_bar(stat = "identity", fill = "green") +
  facet_grid(year ~ month) +
  labs(
    title = "Median ride duration",
    x = "Day of the week",
    y = "Ride duration"
  )

```

I grouped the data by the aspects we want to look at, day, month and year and then took the median of the duration. I also sorted the weekdays and gave them labels that fit into the graph.
We can see that there is almost always longer rides being done on the weekends which makes sense because people are probably using the bikes to go on longer trips instead of going to work. Overall people were doing shorter rides in 2024 than in 2020 which could be due to more routine in using the bikes or the bikes being more established for commuters instead of tourists. We can also note that during workdays the median is quite consistent, showing that the people that are using the bikes to go to work are probably doing that everyday. As mentioned before the orides are also longer in the summer in general, which also makes sense due to the weather conditions. Finally, the bikes overall became more popular in 2024 because time passed and they became more known.

## Looking at e-bikes
```{r}
data_2024 <- cleaned_data %>%
  filter(year == 2024)

ggplot(data_2024, aes(x = rideable_type, y = duration, fill = member_casual)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge") +
  facet_grid(~ month) +
  labs(
    title = "Ride Duration by month, membership and bike type",
    x = "Bike type",
    y = "Average ride duration",
    fill = "Membership"
  ) +
  theme_minimal()
```
I made a barplot to compare the average duration of rides when looking at month, membership and bike type. We can see that non-members generally take longer rides, possibly due to tourists using the bikes or people with less knowledge on how to use them. Members seem to take equally long rides on classic as on electric bikes with a bit of an increase for electric bikes in July. Casual users had on average longer rides with the classic bikes, both in july and january.

























